<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Titan+One&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gun/0.2020.1235/gun.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gun/0.2020.1235/sea.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gun/0.2020.1235/lib/then.js"></script>
    <style>
        :root {
            /* Primary Colors */
            --primary-green: #0a9e6e;
            --primary-orange: #ff9500;
            --pure-white: #ffffff;
            
            /* Secondary Colors */
            --dark-text: #333333;
            --medium-text: #5f5f5f;
            --light-text: rgba(255,255,255,0.7);
            --error-red: #e74c3c;
            
            /* Accent Colors */
            --active-green: #2ecc71;
            --warning-yellow: #ffcc00;
            --shadow: rgba(0,0,0,0.15);
            
            /* Spacing */
            --base-unit: 10px;
            --content-padding: 30px;
            --component-spacing: 20px;
            --element-spacing: 15px;
        }
        
        body {
            font-family: 'Nunito', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--primary-green);
            color: var(--dark-text);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            font-size: 16px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: var(--content-padding);
            width: 100%;
            box-sizing: border-box;
        }
        
        h1 {
            font-family: 'Titan One', sans-serif;
            font-size: 48px;
            color: var(--pure-white);
            text-align: center;
            margin-bottom: var(--component-spacing);
            margin-top: var(--component-spacing);
        }
        
        h2 {
            font-family: 'Montserrat', sans-serif;
            font-size: 32px;
            font-weight: 700;
            margin-bottom: var(--element-spacing);
        }
        
        .card {
            background-color: var(--pure-white);
            border-radius: 16px;
            box-shadow: 0 10px 30px var(--shadow);
            padding: var(--content-padding);
            margin-bottom: var(--component-spacing);
        }
        
        .auth-card {
            max-width: 500px;
            margin: var(--component-spacing) auto;
        }
        
        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 15px;
            margin-bottom: var(--element-spacing);
            border-radius: 12px;
            border: 2px solid #ddd;
            font-family: 'Nunito', sans-serif;
            font-size: 20px;
            color: var(--medium-text);
            box-sizing: border-box;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: 0.3s all;
        }
        
        input[type="text"]:focus,
        input[type="password"]:focus {
            outline: none;
            border-color: var(--primary-green);
            box-shadow: 0 0 0 3px rgba(10, 158, 110, 0.2);
        }
        
        input::placeholder {
            color: #aaa;
            font-style: italic;
        }
        
        button, 
        input[type="submit"],
        input[type="button"] {
            background-color: var(--primary-orange);
            color: var(--pure-white);
            border: none;
            padding: 15px 20px;
            border-radius: 12px;
            font-family: 'Nunito', sans-serif;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            box-shadow: 0 5px 0 rgba(0,0,0,0.2);
            transition: 0.2s all;
            margin-right: var(--element-spacing);
            margin-bottom: var(--element-spacing);
        }
        
        button:hover, 
        input[type="submit"]:hover,
        input[type="button"]:hover {
            transform: scale(1.1);
        }
        
        button:active, 
        input[type="submit"]:active,
        input[type="button"]:active {
            transform: translateY(3px);
            box-shadow: 0 2px 0 rgba(0,0,0,0.2);
        }
        
        .secondary-button {
            background-color: var(--pure-white);
            color: var(--dark-text);
            border: 2px solid #ddd;
            padding: 12px 20px;
        }
        
        .auth-form,
        .message-form {
            display: flex;
            flex-direction: column;
        }
        
        .button-group {
            display: flex;
            justify-content: space-between;
        }
        
        .status {
            display: flex;
            align-items: center;
            margin-bottom: var(--element-spacing);
        }
        
        .status-dot {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .status-loading .status-dot {
            background-color: var(--warning-yellow);
        }
        
        .status-connected .status-dot {
            background-color: var(--active-green);
        }
        
        .status-error .status-dot {
            background-color: var(--error-red);
        }
        
        .status-text {
            font-size: 14px;
            color: var(--medium-text);
        }
        
        .hidden {
            display: none;
        }
        
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 60vh;
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: var(--base-unit);
            margin-bottom: var(--element-spacing);
            background-color: rgba(0,0,0,0.02);
            border-radius: 12px;
        }
        
        .message {
            margin-bottom: var(--element-spacing);
            padding: var(--base-unit);
            border-radius: 8px;
        }
        
        .message.mine {
            background-color: rgba(10, 158, 110, 0.1);
            align-self: flex-end;
            margin-left: 20%;
        }
        
        .message.others {
            background-color: rgba(255, 149, 0, 0.1);
            align-self: flex-start;
            margin-right: 20%;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .username {
            font-weight: 600;
            color: var(--primary-green);
        }
        
        .timestamp {
            color: var(--medium-text);
        }
        
        .message-content {
            word-break: break-word;
        }
        
        .message-form {
            display: flex;
            align-items: center;
        }
        
        .message-input {
            flex: 1;
            margin-right: var(--element-spacing);
            margin-bottom: 0 !important;
        }
        
        .send-button {
            width: auto !important;
            margin-bottom: 0;
        }
        
        .error-message {
            color: var(--error-red);
            font-size: 14px;
            margin-top: -10px;
            margin-bottom: var(--element-spacing);
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 20px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            opacity: 0;
            transition: 0.3s all;
        }
        
        .notification.success {
            background-color: var(--active-green);
        }
        
        .notification.error {
            background-color: var(--error-red);
        }
        
        .notification.show {
            opacity: 1;
        }
        
        /* Rooms related styles */
        .room-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--element-spacing);
            padding-bottom: var(--element-spacing);
            border-bottom: 1px solid #eee;
        }
        
        .room-title {
            margin: 0;
            font-size: 22px;
            font-weight: 700;
        }
        
        .room-actions {
            display: flex;
        }
        
        .rooms-list {
            display: flex;
            overflow-x: auto;
            padding: 10px 0;
            margin-bottom: var(--element-spacing);
            scrollbar-width: thin;
            scrollbar-color: var(--primary-green) #eee;
        }
        
        .room-pill {
            background-color: #f0f0f0;
            padding: 8px 15px;
            border-radius: 20px;
            margin-right: 10px;
            cursor: pointer;
            white-space: nowrap;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .room-pill.active {
            background-color: var(--primary-green);
            color: white;
        }
        
        .room-pill:hover:not(.active) {
            background-color: #e0e0e0;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background-color: white;
            border-radius: 16px;
            padding: var(--content-padding);
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px var(--shadow);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--element-spacing);
        }
        
        .modal-title {
            margin: 0;
            font-size: 24px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            margin: 0;
            padding: 0;
            box-shadow: none;
        }
        
        .close-modal:hover {
            transform: none;
        }
        
        .invite-code {
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 18px;
            margin-bottom: var(--element-spacing);
            word-break: break-all;
        }
        
        .copy-button {
            background-color: var(--primary-green);
            width: 100%;
        }
        
        .room-members {
            margin-top: var(--element-spacing);
        }
        
        .member {
            display: inline-block;
            background-color: #f0f0f0;
            padding: 4px 10px;
            border-radius: 12px;
            margin-right: 5px;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .member.you {
            background-color: rgba(10, 158, 110, 0.2);
        }
        
        .room-meta {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: var(--medium-text);
            margin-bottom: 5px;
        }
        
        .member-count {
            margin-left: 10px;
        }
        
        /* Responsive styles */
        @media (max-width: 768px) {
            h1 {
                font-size: 36px;
            }
            
            h2 {
                font-size: 24px;
            }
            
            .container {
                padding: var(--element-spacing);
            }
            
            .button-group {
                flex-direction: column;
            }
            
            input[type="submit"],
            input[type="button"],
            button {
                width: 100%;
                margin-right: 0;
            }
            
            .message-form {
                flex-direction: column;
            }
            
            .message-input {
                margin-right: 0;
                margin-bottom: var(--element-spacing) !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Chat</h1>
        
        <!-- Auth Card -->
        <div id="auth-card" class="card auth-card">
            <h2>Sign In or Sign Up</h2>
            <div id="auth-status" class="status status-loading">
                <div class="status-dot"></div>
                <div class="status-text">Connecting to network...</div>
            </div>
            <form id="auth-form" class="auth-form">
                <input type="text" id="username" placeholder="Username" required>
                <input type="password" id="password" placeholder="Passphrase" required>
                <div id="error-message" class="error-message hidden"></div>
                <div class="button-group">
                    <input type="submit" id="sign-in" value="Sign In">
                    <input type="button" id="sign-up" value="Sign Up">
                </div>
            </form>
        </div>
        
        <!-- Chat Card (initially hidden) -->
        <div id="chat-card" class="card hidden">
            <div class="status status-connected">
                <div class="status-dot"></div>
                <div class="status-text">Connected as <span id="current-user"></span></div>
                <button id="sign-out" class="secondary-button" style="margin-left: auto;">Sign Out</button>
            </div>
            
            <!-- Rooms List -->
            <div class="rooms-list" id="rooms-list">
                <div class="room-pill active" data-room="public">Public</div>
                <!-- More room pills will be added dynamically -->
                <div class="room-pill" data-room="create">+ New Room</div>
            </div>
            
            <div class="room-header">
                <h3 class="room-title" id="current-room-name">Public Chat</h3>
                <div class="room-actions">
                    <button id="invite-button" class="secondary-button">Invite Others</button>
                </div>
            </div>
            
            <div class="chat-container">
                <div id="messages" class="messages">
                    <!-- Messages will be inserted here -->
                </div>
                <form id="message-form" class="message-form">
                    <input type="text" id="message-input" class="message-input" placeholder="Type your message..." required>
                    <input type="submit" id="send-button" class="send-button" value="Send">
                </form>
            </div>
        </div>
    </div>
    
    <!-- Create Room Modal -->
    <div id="create-room-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Create New Room</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="create-room-form">
                <input type="text" id="room-name" placeholder="Room Name" required>
                <input type="password" id="room-password" placeholder="Room Password (optional)">
                <button type="submit" class="primary-button">Create Room</button>
            </form>
        </div>
    </div>
    
    <!-- Join Room Modal -->
    <div id="join-room-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Join Room</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="join-room-form">
                <input type="text" id="join-room-id" placeholder="Room ID" required>
                <input type="password" id="join-room-password" placeholder="Room Password (if required)">
                <button type="submit" class="primary-button">Join Room</button>
            </form>
        </div>
    </div>
    
    <!-- Invite Modal -->
    <div id="invite-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Invite to <span id="invite-room-name"></span></h3>
                <button class="close-modal">&times;</button>
            </div>
            <p>Share this room ID with others:</p>
            <div class="invite-code" id="invite-code"></div>
            <button id="copy-invite" class="copy-button">Copy Room ID</button>
            
            <div class="room-members">
                <h4>Room Members</h4>
                <div id="member-list">
                    <!-- Members will be inserted here -->
                </div>
            </div>
        </div>
    </div>
    
    <div id="notification" class="notification"></div>
    
    <script>
        // Initialize Gun
        const gun = Gun({
            peers: ['https://gun-manhattan.herokuapp.com/gun'] // Using a public relay peer
        });
        const user = gun.user();
        const SEA = Gun.SEA;
        
        // DOM Elements
        const authCard = document.getElementById('auth-card');
        const chatCard = document.getElementById('chat-card');
        const authForm = document.getElementById('auth-form');
        const authStatus = document.getElementById('auth-status');
        const errorMessage = document.getElementById('error-message');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const signInButton = document.getElementById('sign-in');
        const signUpButton = document.getElementById('sign-up');
        const signOutButton = document.getElementById('sign-out');
        const currentUserSpan = document.getElementById('current-user');
        const messagesContainer = document.getElementById('messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const notificationElement = document.getElementById('notification');
        const roomsList = document.getElementById('rooms-list');
        const currentRoomName = document.getElementById('current-room-name');
        const inviteButton = document.getElementById('invite-button');
        
        // Modal elements
        const createRoomModal = document.getElementById('create-room-modal');
        const joinRoomModal = document.getElementById('join-room-modal');
        const inviteModal = document.getElementById('invite-modal');
        const createRoomForm = document.getElementById('create-room-form');
        const joinRoomForm = document.getElementById('join-room-form');
        const roomNameInput = document.getElementById('room-name');
        const roomPasswordInput = document.getElementById('room-password');
        const joinRoomIdInput = document.getElementById('join-room-id');
        const joinRoomPasswordInput = document.getElementById('join-room-password');
        const inviteRoomName = document.getElementById('invite-room-name');
        const inviteCode = document.getElementById('invite-code');
        const copyInviteButton = document.getElementById('copy-invite');
        const memberList = document.getElementById('member-list');
        const closeModalButtons = document.querySelectorAll('.close-modal');
        
        // App State
        let currentRoom = 'public';
        let userRooms = {};
        
        // Status indicators
        const setStatus = (type, message) => {
            authStatus.className = `status status-${type}`;
            authStatus.querySelector('.status-text').textContent = message;
        };

        // Show error message
        const showError = (message) => {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            setTimeout(() => {
                errorMessage.classList.add('hidden');
            }, 5000);
        };
        
        // Show notification
        const showNotification = (message, type = 'success') => {
            notificationElement.textContent = message;
            notificationElement.className = `notification ${type}`;
            notificationElement.classList.add('show');
            setTimeout(() => {
                notificationElement.classList.remove('show');
            }, 3000);
        };
        
        // Check if user is already authenticated
        const checkAuth = () => {
            setStatus('loading', 'Checking authentication...');
            
            user.recall({sessionStorage: true}, ack => {
                if (user.is) {
                    currentUserSpan.textContent = user.is.alias;
                    authCard.classList.add('hidden');
                    chatCard.classList.remove('hidden');
                    loadUserRooms();
                    loadMessages(currentRoom);
                    setStatus('connected', 'Connected');
                } else {
                    setStatus('connected', 'Ready to sign in');
                }
            });
        };
        
        // Sign in
        const signIn = (e) => {
            e.preventDefault();
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            
            if (!username || !password) {
                showError('Username and password are required');
                return;
            }
            
            setStatus('loading', 'Signing in...');
            
            user.auth(username, password, (ack) => {
                if (ack.err) {
                    setStatus('error', 'Authentication failed');
                    showError(ack.err);
                    return;
                }
                
                currentUserSpan.textContent = username;
                authCard.classList.add('hidden');
                chatCard.classList.remove('hidden');
                authForm.reset();
                loadUserRooms();
                loadMessages(currentRoom);
                showNotification(`Welcome back, ${username}!`);
            });
        };
        
        // Sign up
        const signUp = () => {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            
            if (!username || !password) {
                showError('Username and password are required');
                return;
            }
            
            if (password.length < 8) {
                showError('Password must be at least 8 characters');
                return;
            }
            
            setStatus('loading', 'Creating account...');
            
            user.create(username, password, (ack) => {
                if (ack.err) {
                    setStatus('error', 'Signup failed');
                    showError(ack.err);
                    return;
                }
                
                showNotification('Account created! You can now sign in.');
                setStatus('connected', 'Account created, please sign in');
            });
        };
        
        // Sign out
        const signOut = () => {
            user.leave();
            chatCard.classList.add('hidden');
            authCard.classList.remove('hidden');
            messagesContainer.innerHTML = '';
            // Reset rooms
            roomsList.innerHTML = `
                <div class="room-pill active" data-room="public">Public</div>
                <div class="room-pill" data-room="create">+ New Room</div>
            `;
            currentRoom = 'public';
            currentRoomName.textContent = 'Public Chat';
            showNotification('You have been signed out');
        };
        
        // Format timestamp
        const formatTime = (timestamp) => {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        };
        
        // Add a message to the UI
        const addMessageToUI = (data, key) => {
            if (!data || !data.who || !data.what || !data.when) return;
            
            // Check if message already exists to avoid duplicates
            if (document.getElementById(`msg-${key}`)) return;
            
            const messageDiv = document.createElement('div');
            const isMyMessage = data.who === user.is.alias;
            messageDiv.className = `message ${isMyMessage ? 'mine' : 'others'}`;
            messageDiv.id = `msg-${key}`;
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="username">${data.who}</span>
                    <span class="timestamp">${formatTime(data.when)}</span>
                </div>
                <div class="message-content">${data.what}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        };
        
        // Load messages for a specific room
        const loadMessages = (roomId) => {
            // Clear existing messages
            messagesContainer.innerHTML = '';
            
            // Get room reference
            const roomRef = roomId === 'public' 
                ? gun.get('bloochat') 
                : gun.get('bloochat').get('rooms').get(roomId);
            
            // Subscribe to messages in this room
            roomRef.map().once((data, key) => {
                if (data && data.who && data.what && data.when) {
                    addMessageToUI(data, key);
                }
            });
            
            // Update current room name
            if (roomId === 'public') {
                currentRoomName.textContent = 'Public Chat';
            } else if (userRooms[roomId]) {
                currentRoomName.textContent = userRooms[roomId].name;
            }
            
            // Update room pills
            const roomPills = document.querySelectorAll('.room-pill');
            roomPills.forEach(pill => {
                pill.classList.toggle('active', pill.dataset.room === roomId);
            });
        };
        
        // Send message
        const sendMessage = (e) => {
            e.preventDefault();
            const messageText = messageInput.value.trim();
            
            if (!messageText) return;
            
            const messageData = {
                who: user.is.alias,
                what: messageText,
                when: Date.now()
            };
            
            // Send to the current room
            const roomRef = currentRoom === 'public' 
                ? gun.get('bloochat') 
                : gun.get('bloochat').get('rooms').get(currentRoom);
            
            roomRef.set(messageData);
            
            messageForm.reset();
        };
        
        // Load user's rooms
        const loadUserRooms = () => {
            if (!user.is) return;
            
            // Get user's rooms
            user.get('rooms').map().once((room, roomId) => {
                if (!room) return;
                
                // Add to userRooms object if not already there
                if (!userRooms[roomId]) {
                    userRooms[roomId] = room;
                    addRoomToUI(roomId, room.name);
                }
                
                // Join room members
                const roomRef = gun.get('bloochat').get('rooms').get(roomId);
                roomRef.get('members').set({
                    pub: user.is.pub,
                    alias: user.is.alias,
                    joinedAt: Date.now()
                });
            });
        };
        
        // Add a room pill to the UI
        const addRoomToUI = (roomId, roomName) => {
            // Check if room pill already exists
            const existingPill = document.querySelector(`.room-pill[data-room="${roomId}"]`);
            if (existingPill) return;
            
            // Create new room pill
            const roomPill = document.createElement('div');
            roomPill.className = 'room-pill';
            roomPill.dataset.room = roomId;
            roomPill.textContent = roomName;
            
            // Insert before the "Create Room" pill
            const createRoomPill = document.querySelector('.room-pill[data-room="create"]');
            roomsList.insertBefore(roomPill, createRoomPill);
            
            // Add click event
            roomPill.addEventListener('click', () => switchRoom(roomId));
        };
        
        // Switch to a specific room
        const switchRoom = (roomId) => {
            if (roomId === 'create') {
                openModal(createRoomModal);
                return;
            }
            
            if (roomId === 'join') {
                openModal(joinRoomModal);
                return;
            }
            
            // Update current room
            currentRoom = roomId;
            loadMessages(roomId);
            
            // Update room header
            inviteButton.classList.toggle('hidden', roomId === 'public');
        };
        
        // Create a new room
        const createRoom = async (e) => {
            e.preventDefault();
            
            const roomName = roomNameInput.value.trim();
            const roomPassword = roomPasswordInput.value.trim();
            
            if (!roomName) {
                showNotification('Room name is required', 'error');
                return;
            }
            
            try {
                // Generate a random room ID
                const roomId = SEA.random(16).toString('base64').replace(/[+/=]/g, '').substring(0, 12);
                
                // Create room object
                const roomData = {
                    name: roomName,
                    creator: user.is.pub,
                    createdAt: Date.now(),
                    hasPassword: !!roomPassword
                };
                
                // Encrypt room password if provided
                if (roomPassword) {
                    const encryptedPassword = await SEA.encrypt(roomPassword, user.pair());
                    roomData.password = encryptedPassword;
                }
                
                // Save room to user's rooms
                user.get('rooms').get(roomId).put(roomData);
                
                // Save room to global rooms
                const roomRef = gun.get('bloochat').get('rooms').get(roomId);
                roomRef.put({ name: roomName, creator: user.is.pub, createdAt: Date.now() });
                
                // Add user as member
                roomRef.get('members').set({
                    pub: user.is.pub,
                    alias: user.is.alias,
                    joinedAt: Date.now()
                });
                
                // Add room to userRooms object
                userRooms[roomId] = roomData;
                
                // Add room to UI
                addRoomToUI(roomId, roomName);
                
                // Switch to the new room
                switchRoom(roomId);
                
                // Close modal
                closeModal(createRoomModal);
                createRoomForm.reset();
                
                showNotification(`Room "${roomName}" created successfully!`);
                
                // Show invite modal
                setTimeout(() => {
                    openInviteModal(roomId);
                }, 500);
                
            } catch (error) {
                showNotification('Error creating room: ' + error.message, 'error');
            }
        };
        
        // Join a room
        const joinRoom = async (e) => {
            e.preventDefault();
            
            const roomId = joinRoomIdInput.value.trim();
            const password = joinRoomPasswordInput.value.trim();
            
            if (!roomId) {
                showNotification('Room ID is required', 'error');
                return;
            }
            
            try {
                // Check if room exists
                const roomRef = gun.get('bloochat').get('rooms').get(roomId);
                
                roomRef.once(async (roomData) => {
                    if (!roomData || !roomData.name) {
                        showNotification('Room not found', 'error');
                        return;
                    }
                    
                    // Check if room has password
                    if (roomData.hasPassword && !password) {
                        showNotification('This room requires a password', 'error');
                        return;
                    }
                    
                    // Verify password if needed
                    if (roomData.hasPassword) {
                        // Get password from room creator
                        const creatorUser = gun.user(roomData.creator);
                        creatorUser.get('rooms').get(roomId).once(async (creatorRoomData) => {
                            if (!creatorRoomData || !creatorRoomData.password) {
                                showNotification('Cannot verify room password', 'error');
                                return;
                            }
                            
                            try {
                                const decryptedPassword = await SEA.decrypt(creatorRoomData.password, creatorUser.pair());
                                
                                if (password !== decryptedPassword) {
                                    showNotification('Incorrect room password', 'error');
                                    return;
                                }
                                
                                // Password correct, proceed with joining
                                completeJoinRoom(roomId, roomData);
                                
                            } catch (error) {
                                showNotification('Error verifying password', 'error');
                            }
                        });
                    } else {
                        // No password needed, join directly
                        completeJoinRoom(roomId, roomData);
                    }
                });
                
            } catch (error) {
                showNotification('Error joining room: ' + error.message, 'error');
            }
        };
        
        // Complete the room joining process
        const completeJoinRoom = (roomId, roomData) => {
            // Add room to user's rooms
            user.get('rooms').get(roomId).put({
                name: roomData.name,
                joinedAt: Date.now()
            });
            
            // Add user to room members
            const roomRef = gun.get('bloochat').get('rooms').get(roomId);
            roomRef.get('members').set({
                pub: user.is.pub,
                alias: user.is.alias,
                joinedAt: Date.now()
            });
            
            // Add room to userRooms object
            userRooms[roomId] = {
                name: roomData.name,
                joinedAt: Date.now()
            };
            
            // Add room to UI
            addRoomToUI(roomId, roomData.name);
            
            // Switch to the new room
            switchRoom(roomId);
            
            // Close modal
            closeModal(joinRoomModal);
            joinRoomForm.reset();
            
            showNotification(`Joined room "${roomData.name}" successfully!`);
        };
        
        // Open invite modal
        const openInviteModal = (roomId) => {
            if (currentRoom === 'public') return;
            
            const roomData = userRooms[currentRoom];
            if (!roomData) return;
            
            inviteRoomName.textContent = roomData.name;
            inviteCode.textContent = currentRoom;
            
            // Clear existing members
            memberList.innerHTML = '';
            
            // Add current user
            const currentUserEl = document.createElement('div');
            currentUserEl.className = 'member you';
            currentUserEl.textContent = user.is.alias + ' (you)';
            memberList.appendChild(currentUserEl);
            
            // Load room members
            const roomRef = gun.get('bloochat').get('rooms').get(currentRoom);
            roomRef.get('members').map().once((member) => {
                if (!member || member.pub === user.is.pub) return;
                
                const memberEl = document.createElement('div');
                memberEl.className = 'member';
                memberEl.textContent = member.alias;
                memberList.appendChild(memberEl);
            });
            
            openModal(inviteModal);
        };
        
        // Copy invite code
        const copyInviteCode = () => {
            const code = inviteCode.textContent;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(code)
                    .then(() => {
                        showNotification('Room ID copied to clipboard!');
                        copyInviteButton.textContent = 'Copied!';
                        
                        setTimeout(() => {
                            copyInviteButton.textContent = 'Copy Room ID';
                        }, 2000);
                    })
                    .catch(err => {
                        showNotification('Failed to copy: ' + err.message, 'error');
                    });
            } else {
                // Fallback for browsers that don't support clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = code;
                document.body.appendChild(textArea);
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    showNotification('Room ID copied to clipboard!');
                    copyInviteButton.textContent = 'Copied!';
                    
                    setTimeout(() => {
                        copyInviteButton.textContent = 'Copy Room ID';
                    }, 2000);
                } catch (err) {
                    showNotification('Failed to copy: ' + err.message, 'error');
                }
                
                document.body.removeChild(textArea);
            }
        };
        
        // Modal helpers
        const openModal = (modal) => {
            modal.classList.add('show');
        };
        
        const closeModal = (modal) => {
            modal.classList.remove('show');
        };
        
        // Event listeners
        authForm.addEventListener('submit', signIn);
        signUpButton.addEventListener('click', signUp);
        signOutButton.addEventListener('click', signOut);
        messageForm.addEventListener('submit', sendMessage);
        
        // Room event listeners
        createRoomForm.addEventListener('submit', createRoom);
        joinRoomForm.addEventListener('submit', joinRoom);
        inviteButton.addEventListener('click', () => openInviteModal(currentRoom));
        copyInviteButton.addEventListener('click', copyInviteCode);
        
        // Add event listener to room pills
        roomsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('room-pill')) {
                const roomId = e.target.dataset.room;
                switchRoom(roomId);
            }
        });
        
        // Add "Join Room" pill if not already there
        const addJoinRoomPill = () => {
            if (!document.querySelector('.room-pill[data-room="join"]')) {
                const joinPill = document.createElement('div');
                joinPill.className = 'room-pill';
                joinPill.dataset.room = 'join';
                joinPill.textContent = 'Join Room';
                
                const createRoomPill = document.querySelector('.room-pill[data-room="create"]');
                roomsList.insertBefore(joinPill, createRoomPill);
            }
        };
        
        // Close modal buttons
        closeModalButtons.forEach(button => {
            button.addEventListener('click', () => {
                const modal = button.closest('.modal-overlay');
                closeModal(modal);
            });
        });
        
        // Initialize
        checkAuth();
        addJoinRoomPill();
    </script>
</body>
</html>
